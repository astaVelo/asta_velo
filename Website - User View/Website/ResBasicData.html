<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Radverleih AStA VELO</title>
    <meta name="description" content="Homepage des Fahrradverleihs AStA Velo.">

    <!-- import css stylesheets -->
    <link rel="stylesheet" href="CSS/Basics.css">
    <link rel="stylesheet" href="CSS/TopNav.css">
    <link rel="stylesheet" href="CSS/Formular.css">
    <!-- <link rel="stylesheet" href="CSS/Footer.css"> -->
    <link rel="stylesheet" href="CSS/grid.css">
    <link rel="stylesheet" href="CSS/Kalender.css">

    <!-- import jquery -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.0/angular.js"></script>



    <!--<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *">-->
    <!-- Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <!-- import font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto+Slab|Roboto:300,400,500,700"
        rel="stylesheet">

    <!-- This template defaults to the iOS CSS theme. To support both iOS and material design themes, see the Framework7 Tutorial at the link below:
        http://www.idangero.us/framework7/tutorials/maintain-both-ios-and-material-themes-in-single-app.html
     -->

    <!--<link rel="stylesheet" href="lib/framework7/css/framework7.ios.min.css">
    <link rel="stylesheet" href="lib/framework7/css/framework7.ios.colors.min.css">

    <link rel="stylesheet" href="css/styles.css">-->

</head>


<body>

    <!-- Top Navigation -->
    <div class="topnav">
        <div id="logo">
            <img src="SVG/adminIcon.svg" alt="AStA VELO Logo" id="SVGLogo">
            <a href="home.html" id="home">
                <p id="LogoText">Radverleih AStA-VELO</p>
            </a>
        </div>

        <div id="social">
            <p id="email">Tel.: +49 681 - 302 2900 | velo@asta.uni-saarland.de</p>
            <a target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/AStA.UdS"><img
                    id="first-top-logo" class="topnav-social-logos" src="SVG/facebook-logo.svg" alt="Facebook"
                    id="FacebookLogo"></a>
            <a target="_blank" rel="noopener noreferrer" href="https://www.twitter.com/AStA_UdS"><img
                    class="topnav-social-logos" src="SVG/twitter.svg" alt="Twitter" id="TwitterLogo"></a>
            <a target="_blank" rel="noopener noreferrer" href="https://www.instagram.com/asta_uds/"><img
                    class="topnav-social-logos" src="SVG/instagram.svg" alt="Instagram" id="InstagramLogo"></a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="mainsite" ng-App="myApp" ng-Controller="myCtrl">
        <div class="outercontainer">

            <div class="container" id="reservation_container">
                <div class="form">
                    <h2>AStA Velo Reservierung</h2>
                    <p>Bitte fülle alle untenstehenden Felder aus.<br>
                        Die angegebenen Information helfen uns, deine Ausleihe so einfach wie möglich zu gestalten und mit dir in Kontakt zu bleiben.<br> 
                        Please fill out all fields below.<br>
                        The information provided will help us to make your loan as easy as possible and to stay in contact with you.</p>

                    <input id="one" type="radio" name="stage" checked="checked" disabled="disabled" />
                    <input id="two" type="radio" name="stage" disabled="disabled" />
                    <input id="three" type="radio" name="stage" disabled="disabled" />

                    <div class="stages">
                        <label for="one">1</label>
                        <label for="two">2</label>
                        <label for="three">3</label>
                    </div>

                    <span class="progress"><span></span></span>

                    <div class="panels">
                        <div data-panel="one" id="data_panel_one">
                            <h4>Kontaktinformationen/Contact details</h4>
                            <p class="FormHeading">Vorname/Firstname</p>
                            <input type="text" id="vorname" ng-model="vorname" placeholder="Vorname" required />
                            <p class="FormHeading">Nachname/Lastname</p>
                            <input type="text" id="nachname" ng-model="nachname" placeholder="Nachname" required />
                            <p class="FormHeading">E-Mail Adresse/Email address</p>
                            <input type="text" id="e-mail" ng-model="email" placeholder="E-Mail" required />

                            <p class="FormHeading">Geburtsdatum/Date of birth</p>
                            <input type="text" id="geburtsdatum" ng-model="birthday" placeholder="DD.MM.YYYY"
                                required />
                            <p class="FormHeading">Straße Hausnummer/Street address</p>
                            <input type="text" id="strasse" ng-model="street" placeholder="Straße" required />
                            <p class="FormHeading">Ort/Place of residence</p>
                            <input type="text" id="ort" ng-model="ort" placeholder="Ort" required />

                            <h4 class="SecondHeading">Zusätzliche Informationen/More details</h4>
                            <p class="FormHeading">Telefonnummer/Phone number*</p>
                            <input type="text" id="nummer" ng-model="nummer" placeholder="Telefonnummer*" required />
<!--                             <p class="FormHeading" id="specialhint">Die Angabe der Körpergröße ermöglicht es uns die
                                Auswahl der zu dir passenden Fahrrädern zu optimieren.</p> -->
<!--                             <p class="FormHeading">Körpergröße (cm)*</p>
                            <input type="text" id="koerpergroesse" ng-model="groesse" placeholder="Größe (cm)"
                                required /> -->
                            <button id="button_panel_one" type="submit">Weiter</button>
                        </div>

                        <div data-panel="two" id="data_panel_two">
                            <h4>Wähle deine Wunsch-Fahrräder aus/Choose your favourite bike:</h4>
                            <section class="row">
                                <section class="column" ng-repeat="x in data">
                                    <section class=item>
                                        <img src="{{x.image_url}}" >

                                        <section class="imgsub">
                                            <label class="check">
                                                <input type="checkbox" ng-model="x.selected" name="checkbox"
                                                    value="{{x.id}}">
                                                <span class="checkmark"></span>
                                            </label>
                                            <section class="subscription">
                                                <p class="subscriptiondetail">
                                                    Type:&nbsp;{{x.type}}<br>
                                                    Höhe:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{x.size}}<br>
                                                    Gänge:&nbsp;&nbsp;&nbsp; {{x.number_of_gears}}<br>
                                                    Bremse:&nbsp; {{x.type_of_breaks}}<br>
                                                    <span ng-if="x.information.length > 0">Anmerkungen:&nbsp;{{x.information}}<span>
                                                </p>
                                            </section>
                                        </section>
                                    </section>
                                </section>
                            </section>
                            <button id="button_panel_two">Weiter</button>

                        </div>
                        <div data-panel="three" id="data_panel_three">
                            <h4>Wähle den Zeitraum, in dem du dir ein Fahrrad ausleihen möchtest/Select a period for your bike:</h4>
                            <p class="FormHeading">Startdatum der Ausleihe/Start date:</p>
                            <input type="text" ng-model="start_date" name="rentdate" id="today"
                                placeholder="DD.MM.YYYY">
                            <input type="text" ng-model="start_time" name="renttime" id="today" placeholder="HH:MM">
                            <p class="FormHeading">Rückgabe des Fahrrads/End date:</p>
                            <input type="text" ng-model="end_date" name="rentdate" id="tomorrow"
                                placeholder="DD.MM.YYYY">
                            <input type="text" ng-model="end_time" name="renttime" id="tomorrow" placeholder="HH:MM">

                            <p>Bitte achte auf unsere Öffnungszeiten!</p>
                            <p>Please pay attention to the opening hours</p>

                            <p>Ich möchte mich für den Newsletter anmelden/Would you like to subscribe to the newsletter ?
                            <input type="checkbox" id="newsletter_checkbox" name="newsletter" ng-model="newsletter" /></p>
                            <p>Wenn du auf 'Fertig' gehst, akzeptierst du automatisch den/ When you press 'Fertig', you accept the <a
                                    href="Mietvertrag_Fahrradverleih_AStA_velo.pdf" target="_blank">
                                    Mietvertrag</a>.
                            </p>
                            <button id="button_panel_three">Fertig</button>
                        </div>
                    </div>
                    <p id="hint">* Dieses Feld ist optional/These fields are optional .</p>

                </div>

            </div>

            <div class="container" id="danke_container" style="display:none">
                <div class="form" style="min-height: 300px">
                    <div style="height:300px; width:300px; text-align:center; position:absolute; left:35%; top:4%;">
                        <span class="danke"
                            style="color: #76C659; display: inline-block; font-size: 120px; vertical-align: center; border-color: #76C659;">&#10003;</span>
                        <h1>Vielen Dank für deine Anfrage!</h1>
                        <h2>Many thanks for your inquiry!</h2>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>

<script>
    var app = angular.module('myApp', []);
    app.controller('myCtrl', function ($scope, $http) {
        var localhost = 'http://127.0.0.1:5000/'
        var selectedBikes = [];
        var button_one = document.getElementById('button_panel_one')
        var newsletter_checkbox = document.getElementById('newsletter_checkbox')
        var response_size;

        var config = {
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Access-Control-Allow-Origin': '*'
            }
        }

        // was in there twice
        // var localhost = 'http://127.0.0.1:5000/'


        //Get all reservations request
        setTimeout(function () {
            $http.get(localhost + "admin/api/v1/reservations/1001337", config).then(function (response) {
                // console.log(response.data.length);
                $scope.response_size = response.data.length;
            });
        }, 200);

        //button panel one
        button_one.onclick = function () {
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

            if ($scope.nummer == null) {
                $scope.nummer = "NONE"
            }
            if ($scope.groesse == null) {
                $scope.groesse = "NONE"
            }

            if ($scope.vorname == null || $scope.nachname == null || $scope.email == null || $scope.street == null || $scope.ort == null || $scope.birthday == null) {
                alert("Bitte füllen Sie die notwendigen Felder aus!")
            } else {

                //check if email is valid
                var valide_email = re.test($scope.email);

                //check if date is valid
                const dataRe = /^[0-9]{2}\.[0-1][0-9]\.[1-2][0-9]{3}$/;
                var valides_datum = dataRe.test($scope.birthday);

                var short_months = ["02","04","06","09","11"]

                //format dd.mm.yyyy
                if (valides_datum){
                    parts = $scope.birthday.split(".")
                    //before 1920 or after 2020
                    if ((parseInt(parts[2]) > 2020) || (parseInt(parts[2]) < 1920)){
                        valides_datum = false;
                    }
                    //day <1 or >31
                    else if ((parseInt(parts[0]) < 1) || (parseInt(parts[0]) > 31)){
                        valides_datum = false;
                    }
                    //month <1 or >12
                    else if ((parseInt(parts[1]) < 1) || (parseInt(parts[1]) > 12)){
                        valides_datum = false;
                    }
                    //31st day on a 30-day month
                    else if ((short_months.includes(parts[1])) && (parts[0] == "31")){
                        valides_datum = false;
                    }
                }

                if (!valide_email) {
                    alert("Bitte geben Sie eine gültige Mailadresse an!")
                }

                else if (!valides_datum) {
                    alert("Bitte geben Sie ein gültiges Geburtsdatum an!")
                }

                else {

                    var input_radio_button = document.getElementById('two').setAttribute('checked', 'checked')
                    document.getElementById('hint').style.display = 'none'
                    document.getElementById('data_panel_one').style.display = 'none'
                    document.getElementById('data_panel_two').style.display = 'block'

                    //send get Request to get all available Bikes
                    $http.get(localhost + "service/api/v1/availableBikes/1337", config)
                        .then(function (response) {
                            $scope.data = response.data;
                            console.log(response.data)
                        });
                }
            }
        }


        var button_two = document.getElementById('button_panel_two')
        //button panel two
        button_two.onclick = function () {
            var input_radio_button = document.getElementById('three').setAttribute('checked', 'checked')

            $.each($("input[name='checkbox']:checked"), function () {
                first = true
                console.log($(this).val())
                selectedBikes.push($(this).val());
            });

            selectedBikes.sort();
            $scope.bike_ids = selectedBikes.join('###')
            console.log($scope.bike_ids + "")

            if (selectedBikes.length == 0) {
                alert("Bitte wähle ein für dich passendes Fahrrad aus!")
            } else {
                document.getElementById('data_panel_two').style.display = 'none'
                document.getElementById('data_panel_three').style.display = 'block'
            }

        }

        var button_three = document.getElementById('button_panel_three')

        //button panel three
        button_three.onclick = function () {
            if ($scope.start_date == null || $scope.start_time == null) {
                alert("Bitte gebe eine gewünschte Startzeit der Ausleihe ein!")
            } 
            else if ($scope.end_date == null || $scope.end_time == null) {
                    alert("Bitte gebe eine gewünschte Endzeit der Ausleihe ein!")
                }
            else {
                    //check correct format of start_date and end_date
                    function check_format(date, time){
                    	const dataRe = /^[0-9]{2}\.[0-1][0-9]\.[1-2][0-9]{3}$/;
                    	const zeitRe = /^[0-2][0-9]\:[0-5][0-9]$/;

                    	var valides_datum = dataRe.test(date);
                    	var valide_zeit = zeitRe.test(time)

		                var short_months = ["02","04","06","09","11"]

		                //format dd.mm.yyyy
		                if (valides_datum){
		                    parts = date.split(".")
		                    //before 1920 or after 2020
		                    if ((parseInt(parts[2]) > 2020) || (parseInt(parts[2]) < 1920)){
		                        valides_datum = false;
		                    }
		                    //day <1 or >31
		                    else if ((parseInt(parts[0]) < 1) || (parseInt(parts[0]) > 31)){
		                        valides_datum = false;
		                    }
		                    //month <1 or >12
		                    else if ((parseInt(parts[1]) < 1) || (parseInt(parts[1]) > 12)){
		                        valides_datum = false;
		                    }
		                    //31st day on a 30-day month
		                    else if ((short_months.includes(parts[1])) && (parts[0] == "31")){
		                        valides_datum = false;
		                    }
		                }

		                if (valide_zeit){
                    		parts = time.split(":")

		                    if ((parseInt(parts[0])>23) || (parseInt(parts[1])>59)){
		                        valide_zeit = false;
		                    }
                		}

                		return [valides_datum, valide_zeit]
                    }

                    var valid_start = check_format($scope.start_date,$scope.start_time)
                    var valid_end = check_format($scope.end_date, $scope.end_time)

                    if ((valid_start[0] == false) || (valid_start[1] == false)){
                    	alert("Bitte gebe ein gültiges Startdatum an!")

                    } else if ((valid_end[0] == false) || (valid_end[1] == false)){
                    	alert("Bitte gebe ein gültiges Enddatum an!")
                    } else{
                    	//concat the two string value into the correct format DD.MM.YYYY.HH:MM
	                    $scope.start_date = $scope.start_date + "." + $scope.start_time
	                    $scope.end_date = $scope.end_date + "." + $scope.end_time

	                    //document.getElementsByClassName('panels').style.display = 'none'
	                    document.getElementById('reservation_container').style.display = 'none'
	                    document.getElementById('danke_container').style.display = 'block'


	                    //send reservation request 
	                    var json_data_reservation = JSON.stringify({
	                        id: 0, date_from: $scope.start_date, date_to: $scope.end_date, bike_ids: $scope.bike_ids, confirmed: false, email: $scope.email
	                    })

	                    console.log(json_data_reservation);

	                    var json_newsletter = JSON.stringify({
	                        id: 0, email: $scope.email
	                    })
	                    var json_data_appointment = JSON.stringify({
	                        id: 0, date_time: $scope.start_date, confirmed: false, type: 'pickup', reservation_id: 0, loan_id: 0,
	                        start_date: $scope.start_date, end_date: $scope.end_date, loan_duration: 0, price: 0, status: 'string', email: $scope.email, bike_ids: $scope.bike_ids,
	                        first_name: $scope.vorname, last_name: $scope.nachname, phone_number: $scope.nummer, deposit: 0, number_of_bikes: selectedBikes.length, birthday: $scope.birthday, street: $scope.street, location: $scope.ort
	                    })

	                    console.log(json_data_appointment);

	                    sendReservationRequest($http, json_data_reservation, config);

	                    sendNewsletterRequest($http, json_newsletter, config);

	                    sendAppointmentRequest($http, json_data_appointment, config)

                    }

                }

        }



    });

	function sendReservationRequest($http, json_data_reservation, config) {
			console.log("reserv");
		    $http.post("http://127.0.0.1:5000/actions/api/v1/sendReservationRequest", json_data_reservation, config).then(function (response) {
            console.log(response)
                    });
	}

    function sendNewsletterRequest($http, json_newsletter, config) {
            if (newsletter_checkbox.checked == true) {
                //send Newsletter Request
                $http.post("http://127.0.0.1:5000/actions/api/v1/sendNewsletterRequest", json_newsletter, config).then(function (response) {
                	console.log(response)
                });
            }
        
    }

    function sendAppointmentRequest($http, json_data, config) {
    	console.log("appt");
        $http.post("http://127.0.0.1:5000/actions/api/v1/sendAppointmentRequest", json_data, config).then(function (response) {
            console.log(response)
        });

    }

</script>

</html>